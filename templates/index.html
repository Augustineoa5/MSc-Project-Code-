<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Household SmartMeter Consumption Anomaly Detection</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .model-card {
            border-left: 4px solid #007bff;
            margin-bottom: 1rem;
        }
        .training-card {
            border-left: 4px solid #28a745;
        }
        .testing-card {
            border-left: 4px solid #ffc107;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success {
            background-color: #28a745;
        }
        .status-pending {
            background-color: #ffc107;
        }
        .status-error {
            background-color: #dc3545;
        }
        .progress-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .model-type-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .results-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #ffffff;
        }
        .collapsible-section {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .collapsible-section:hover {
            background-color: #f8f9fa;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 10;
            padding: 1rem 0;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header Section -->
        <div class="sticky-header">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0">
                        <i class="fas fa-brain text-primary"></i>
                        Household SmartMeter Consumption Anomaly Detection
                    </h1>
                    <p class="text-muted mb-0">Train multiple anomaly detection models sequentially and test them with the same or similar dataset</p>
                </div>
                <div class="col-auto">
                    <button id="resetBtn" class="btn btn-outline-danger">
                        <i class="fas fa-redo"></i> Reset All
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-section">
            <div class="row text-center">
                <div class="col-md-2">
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="status-indicator {% if train_data_uploaded %}status-success{% else %}status-pending{% endif %}"></span>
                        <strong>1. Upload Training Data</strong>
                    </div>
                    <small class="text-muted d-block mt-1">
                        {% if train_data_uploaded %}✓ Data uploaded{% else %}Upload CSV file{% endif %}
                    </small>
                </div>
                <div class="col-md-2">
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="status-indicator {% if models_trained %}status-success{% else %}status-pending{% endif %}"></span>
                        <strong>2. Train Models</strong>
                    </div>
                    <small class="text-muted d-block mt-1">
                        {% if models_trained %}✓ Models available{% else %}Train models{% endif %}
                    </small>
                </div>
                <div class="col-md-2">
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="status-indicator {% if test_data_uploaded %}status-success{% else %}status-pending{% endif %}"></span>
                        <strong>3. Upload Test Data</strong>
                    </div>
                    <small class="text-muted d-block mt-1">
                        {% if test_data_uploaded %}✓ Test data ready{% else %}Upload test CSV{% endif %}
                    </small>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="status-indicator {% if test_results %}status-success{% else %}status-pending{% endif %}"></span>
                        <strong>4. Test All Models</strong>
                    </div>
                    <small class="text-muted d-block mt-1">
                        {% if test_results %}✓ Testing complete{% else %}Test all models{% endif %}
                    </small>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="status-indicator {% if train_results and test_results %}status-success{% else %}status-pending{% endif %}"></span>
                        <strong>5. Compare Results</strong>
                    </div>
                    <small class="text-muted d-block mt-1">
                        {% if train_results and test_results %}✓ Ready to compare{% else %}View comparisons{% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Error:</strong> {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if success_message %}
        <div class="alert alert-success alert-dismissible fade show fade-in" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>Success:</strong> {{ success_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row">
            <!-- Training Section -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-upload"></i>
                            Training Phase
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Upload Training Data -->
                        <div class="mb-4">
                            <h6 class="fw-bold">
                                <i class="fas fa-database"></i>
                                Step 1: Upload Training Data
                            </h6>
                            
                            <form action="/upload_train" method="post" enctype="multipart/form-data" class="mb-3" id="uploadTrainForm">
                                <div class="mb-3">
                                    <input type="file" name="file" accept=".csv" class="form-control" id="trainFileInput" required>
                                    <small class="form-text text-muted">Select a CSV file with your training data</small>
                                </div>
                                <button type="submit" class="btn btn-primary" id="uploadTrainBtn">
                                    <i class="fas fa-upload"></i> Upload Training Data
                                </button>
                            </form>

                            {% if train_data_uploaded %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                Training data uploaded successfully!
                            </div>
                            {% endif %}

                            <!-- Training Data Preview -->
                            {% if train_preview %}
                            <div class="mt-3">
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#trainPreview">
                                    <i class="fas fa-eye"></i> View Training Data Preview
                                </button>
                                <div class="collapse mt-2" id="trainPreview">
                                    <div class="border rounded p-2" style="max-height: 300px; overflow: auto;">
                                        {{ train_preview | safe }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <hr>

                        <!-- Train Models -->
                        <div class="mb-4">
                            <h6 class="fw-bold">
                                <i class="fas fa-cogs"></i>
                                Step 2: Train Models (Sequential)
                            </h6>
                            
                            {% if train_data_uploaded %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="modelTypeSelect" class="form-label">Select Model Type:</label>
                                    <select id="modelTypeSelect" name="model_type" class="form-select mb-3">
                                        <option value="rf">Random Forest</option>
                                        <option value="if">Isolation Forest</option>
                                        <option value="dt">Decision Tree</option>
                                        <option value="xgb">XGBoost</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-success w-100" id="trainModelBtn">
                                <i class="fas fa-play"></i> Train Selected Model
                            </button>
                            
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle"></i>
                                You can train multiple models one after another. Each model's results will be preserved.
                            </small>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Please upload training data first.
                            </div>
                            {% endif %}
                        </div>

                        <!-- Training Results -->
                        {% if train_results %}
                        <div class="mb-4">
                            <h6 class="fw-bold">
                                <i class="fas fa-chart-line"></i>
                                Training Results
                            </h6>
                            <div class="results-container training-card">
                                {{ train_results | safe }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Testing Section -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-vial"></i>
                            Testing Phase
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Upload Test Data -->
                        <div class="mb-4">
                            <h6 class="fw-bold">
                                <i class="fas fa-file-upload"></i>
                                Step 1: Upload Test Data
                            </h6>
                            
                            <form action="/upload_test_data" method="post" enctype="multipart/form-data" class="mb-3" id="uploadTestForm">
                                <div class="mb-3">
                                    <input type="file" name="file" accept=".csv" class="form-control" id="testFileInput" required>
                                    <small class="form-text text-muted">Select a CSV file with your test data</small>
                                </div>
                                <button type="submit" class="btn btn-warning" id="uploadTestBtn">
                                    <i class="fas fa-upload"></i> Upload Test Data
                                </button>
                            </form>

                            {% if test_data_uploaded %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                Test data uploaded successfully!
                            </div>
                            {% endif %}

                            <!-- Test Data Preview -->
                            {% if test_preview %}
                            <div class="mt-3">
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#testPreview">
                                    <i class="fas fa-eye"></i> View Test Data Preview
                                </button>
                                <div class="collapse mt-2" id="testPreview">
                                    <div class="border rounded p-2" style="max-height: 300px; overflow: auto;">
                                        {{ test_preview | safe }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <hr>

                        <!-- Test Models -->
                        <div class="mb-4">
                            <h6 class="fw-bold">
                                <i class="fas fa-vial"></i>
                                Step 2: Test All Trained Models
                            </h6>
                            
                            {% if models_trained and test_data_uploaded %}
                            <button type="button" class="btn btn-warning w-100" id="testAllModelsBtn">
                                <i class="fas fa-vial"></i> Test All Models Simultaneously
                            </button>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle"></i>
                                This will test all trained models using the uploaded test dataset.
                            </small>
                            {% elif not models_trained %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Train at least one model before testing.
                            </div>
                            {% elif not test_data_uploaded %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Upload test data first.
                            </div>
                            {% endif %}
                        </div>

                        <!-- Test Results -->
                        {% if test_results %}
                        <div class="mb-4">
                            <h6 class="fw-bold">
                                <i class="fas fa-chart-bar"></i>
                                Test Results
                            </h6>
                            <div class="results-container testing-card">
                                {{ test_results | safe }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Features & Instructions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb"></i>
                            How It Works
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6><i class="fas fa-arrow-right text-primary"></i> Sequential Training</h6>
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-check text-success"></i> Train models one after another</li>
                                    <li><i class="fas fa-check text-success"></i> Each model's results are preserved</li>
                                    <li><i class="fas fa-check text-success"></i> Choose different algorithms</li>
                                    <li><i class="fas fa-check text-success"></i> Compare performance easily</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-arrow-right text-warning"></i> Efficient Testing</h6>
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-check text-success"></i> Upload test data once</li>
                                    <li><i class="fas fa-check text-success"></i> Test all trained models automatically</li>
                                    <li><i class="fas fa-check text-success"></i> Side-by-side comparison</li>
                                    <li><i class="fas fa-check text-success"></i> Individual performance metrics</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-arrow-right text-info"></i> Persistent Results</h6>
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-check text-success"></i> Results don't disappear</li>
                                    <li><i class="fas fa-check text-success"></i> Unique plots for each model</li>
                                    <li><i class="fas fa-check text-success"></i> Training and testing history</li>
                                    <li><i class="fas fa-check text-success"></i> Easy model identification</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div id="loadingText">Processing...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let loadingModal;
        let isTraining = false;
        let isTesting = false;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            initializeEventListeners();
            updateProgressIndicators();
        });

        function initializeEventListeners() {
            // Training data upload form
            const uploadTrainForm = document.getElementById('uploadTrainForm');
            if (uploadTrainForm) {
                uploadTrainForm.addEventListener('submit', handleTrainingDataUpload);
            }

            // Model training button
            const trainModelBtn = document.getElementById('trainModelBtn');
            if (trainModelBtn) {
                trainModelBtn.addEventListener('click', handleModelTraining);
            }

            // Test data upload form
            const uploadTestForm = document.getElementById('uploadTestForm');
            if (uploadTestForm) {
                uploadTestForm.addEventListener('submit', handleTestDataUpload);
            }

            // Test all models button
            const testAllModelsBtn = document.getElementById('testAllModelsBtn');
            if (testAllModelsBtn) {
                testAllModelsBtn.addEventListener('click', handleTestAllModels);
            }

            // Reset button
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', handleReset);
            }

            // Auto-hide alerts after 5 seconds
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                if (!alert.classList.contains('alert-info') && !alert.classList.contains('alert-warning')) {
                    setTimeout(() => {
                        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                        bsAlert.close();
                    }, 5000);
                }
            });
        }

        function handleTrainingDataUpload(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const fileInput = document.getElementById('trainFileInput');
            
            if (!fileInput.files.length) {
                showNotification('Please select a training data file.', 'warning');
                return;
            }

            showLoadingModal('Uploading and processing training data...');
            updateUploadTrainButton(true);

            fetch('/upload_train', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                hideLoadingModal();
                
                // Replace the entire page content
                document.open();
                document.write(html);
                document.close();
            })
            .catch(error => {
                console.error('Upload error:', error);
                hideLoadingModal();
                showNotification('Error uploading training data. Please try again.', 'danger');
            })
            .finally(() => {
                updateUploadTrainButton(false);
            });
        }

        function handleModelTraining(event) {
            event.preventDefault();
            
            if (isTraining) {
                showNotification('Training in progress, please wait...', 'warning');
                return;
            }

            const modelSelect = document.getElementById('modelTypeSelect');
            const modelType = modelSelect.value;
            
            const formData = new FormData();
            formData.append('model_type', modelType);
            
            isTraining = true;
            showLoadingModal(`Training ${getModelName(modelType)} model...`);
            updateTrainButton(true);

            fetch('/train_model', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                hideLoadingModal();
                
                // Replace the entire page content to show updated results
                document.open();
                document.write(html);
                document.close();
                
                // Show success notification
                showNotification(`${getModelName(modelType)} model trained successfully!`, 'success');
            })
            .catch(error => {
                console.error('Training error:', error);
                hideLoadingModal();
                showNotification('Error during model training. Please try again.', 'danger');
            })
            .finally(() => {
                isTraining = false;
                updateTrainButton(false);
            });
        }

        function handleTestDataUpload(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const fileInput = document.getElementById('testFileInput');
            
            if (!fileInput.files.length) {
                showNotification('Please select a test data file.', 'warning');
                return;
            }

            showLoadingModal('Uploading and processing test data...');
            updateUploadTestButton(true);

            fetch('/upload_test_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                hideLoadingModal();
                
                // Replace the entire page content
                document.open();
                document.write(html);
                document.close();
            })
            .catch(error => {
                console.error('Test upload error:', error);
                hideLoadingModal();
                showNotification('Error uploading test data. Please try again.', 'danger');
            })
            .finally(() => {
                updateUploadTestButton(false);
            });
        }

        function handleTestAllModels(event) {
            event.preventDefault();
            
            if (isTesting) {
                showNotification('Testing in progress, please wait...', 'warning');
                return;
            }
            
            isTesting = true;
            showLoadingModal('Testing all trained models...');
            updateTestAllButton(true);

            fetch('/test_all_models', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(html => {
                hideLoadingModal();
                
                // Replace the entire page content to show updated results
                document.open();
                document.write(html);
                document.close();
                
                // Show success notification
                showNotification('All models tested successfully!', 'success');
            })
            .catch(error => {
                console.error('Testing error:', error);
                hideLoadingModal();
                showNotification('Error during model testing. Please try again.', 'danger');
            })
            .finally(() => {
                isTesting = false;
                updateTestAllButton(false);
            });
        }

        function handleReset() {
            if (isTraining || isTesting) {
                showNotification('Cannot reset while training or testing is in progress.', 'warning');
                return;
            }

            if (confirm('Are you sure you want to reset all data and trained models? This action cannot be undone.')) {
                showLoadingModal('Resetting application...');
                
                fetch('/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    hideLoadingModal();
                    
                    if (data.error) {
                        showNotification('Error during reset: ' + data.error, 'danger');
                    } else {
                        showNotification('Application reset successfully!', 'success');
                        
                        // Redirect to home page after a short delay
                        setTimeout(() => {
                            window.location.href = data.redirect || '/';
                        }, 1500);
                    }
                })
                .catch(error => {
                    console.error('Reset error:', error);
                    hideLoadingModal();
                    showNotification('Error during reset. Please try again.', 'danger');
                });
            }
        }

        function showLoadingModal(text) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = text;
            }
            loadingModal.show();
        }

        function hideLoadingModal() {
            loadingModal.hide();
        }

        function updateTrainButton(isLoading) {
            const trainBtn = document.getElementById('trainModelBtn');
            if (trainBtn) {
                if (isLoading) {
                    trainBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Training...';
                    trainBtn.disabled = true;
                } else {
                    trainBtn.innerHTML = '<i class="fas fa-play"></i> Train Selected Model';
                    trainBtn.disabled = false;
                }
            }
        }

        function updateUploadTrainButton(isLoading) {
            const uploadBtn = document.getElementById('uploadTrainBtn');
            if (uploadBtn) {
                if (isLoading) {
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
                    uploadBtn.disabled = true;
                } else {
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Training Data';
                    uploadBtn.disabled = false;
                }
            }
        }

        function updateUploadTestButton(isLoading) {
            const uploadBtn = document.getElementById('uploadTestBtn');
            if (uploadBtn) {
                if (isLoading) {
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
                    uploadBtn.disabled = true;
                } else {
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Test Data';
                    uploadBtn.disabled = false;
                }
            }
        }

        function updateTestAllButton(isLoading) {
            const testBtn = document.getElementById('testAllModelsBtn');
            if (testBtn) {
                if (isLoading) {
                    testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Testing...';
                    testBtn.disabled = true;
                } else {
                    testBtn.innerHTML = '<i class="fas fa-vial"></i> Test All Models Simultaneously';
                    testBtn.disabled = false;
                }
            }
        }

        function updateProgressIndicators() {
            // This function updates the progress indicators based on current state
            // Implementation depends on the server-side template variables
            
            const indicators = document.querySelectorAll('.status-indicator');
            
            // Check if training data is uploaded
            const trainDataUploaded = {{ 'true' if train_data_uploaded else 'false' }};
            if (trainDataUploaded && indicators[0]) {
                indicators[0].classList.remove('status-pending');
                indicators[0].classList.add('status-success');
            }
            
            // Check if models are trained
            const modelsTrained = {{ 'true' if models_trained else 'false' }};
            if (modelsTrained && indicators[1]) {
                indicators[1].classList.remove('status-pending');
                indicators[1].classList.add('status-success');
            }
        }

        function getModelName(modelType) {
            const modelNames = {
                'rf': 'Random Forest',
                'if': 'Isolation Forest',
                'dt': 'Decision Tree',
                'xgb': 'XGBoost'
            };
            return modelNames[modelType] || modelType.toUpperCase();
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show fade-in`;
            alertDiv.innerHTML = `
                <i class="fas fa-${getIconForType(type)}"></i>
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container-fluid');
            const stickyHeader = container.querySelector('.sticky-header');
            container.insertBefore(alertDiv, stickyHeader.nextSibling);
            
            // Auto-hide after 5 seconds for non-persistent alerts
            if (type !== 'info' && type !== 'warning') {
                setTimeout(() => {
                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                    bsAlert.close();
                }, 5000);
            }
        }

        function getIconForType(type) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Enhanced plot viewing
        document.addEventListener('click', function(event) {
            if (event.target.matches('a[href*="/plot/"]')) {
                event.preventDefault();
                const plotUrl = event.target.href;
                
                // Open plot in a modal or new window
                const plotWindow = window.open(plotUrl, 'plotWindow', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                if (!plotWindow) {
                    // If popup blocked, show notification
                    showNotification('Please allow popups to view plots, or right-click and "Open in new tab"', 'info');
                }
            }
        });

        // File input validation
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        showNotification('Please select a CSV file.', 'warning');
                        this.value = '';
                        return;
                    }
                    
                    if (file.size > 50 * 1024 * 1024) { // 50MB limit
                        showNotification('File size should be less than 50MB.', 'warning');
                        this.value = '';
                        return;
                    }
                    
                    // Show file info
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    console.log(`Selected file: ${file.name} (${fileSize} MB)`);
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl+R for reset (with confirmation)
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn && !isTraining && !isTesting) {
                    resetBtn.click();
                }
            }
            
            // Escape to close modals
            if (event.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.show');
                openModals.forEach(modal => {
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                });
            }
        });

        // Page visibility handling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, could pause some operations
                console.log('Page hidden');
            } else {
                // Page is visible again
                console.log('Page visible');
                
                // Could refresh status or check for updates
                updateProgressIndicators();
            }
        });

        // Prevent form resubmission on page reload
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    </script>
</body>
</html>